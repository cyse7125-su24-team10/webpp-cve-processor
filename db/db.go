package db

import (
	"database/sql"
	"fmt"

	"github.com/cyse7125-su24-team10/webpp-cve-processor/config"
	_ "github.com/lib/pq"
)

func GetPostgresConn() (*sql.DB, error) {
	psqlInfo := fmt.Sprintf("host=%s port=%s user=%s "+"password=%s dbname=%s sslmode=disable",
		config.Envs.DbHost, config.Envs.DbPort, config.Envs.DbUser, config.Envs.DbPassword, config.Envs.DbName)

	db, err := sql.Open("postgres", psqlInfo)
	if err != nil {
		return nil, err
	}

	_, err = db.Exec(fmt.Sprintf("SET search_path TO %s", config.Envs.DbSchema))
	if err != nil {
		db.Close() // Close the connection if setting search_path fails
		return nil, err
	}

	return db, nil
}
